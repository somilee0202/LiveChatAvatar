<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Live2D Viewer</title>

    <!-- PixiJS 최신 버전 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.10/browser/pixi.min.js"></script>

    <!-- Cubism Core (라이브2D 필수!) -->
    <script src="https://cdn.jsdelivr.net/npm/live2dcubismcore@1.0.2/live2dcubismcore.min.js"></script>

    <!-- pixi-live2d-display Cubism4 지원 -->
    <script src="https://unpkg.com/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>
  </head>
  <style>
    canvas {
      height: 500px; /* 원하는 만큼 줄이기 */
      object-fit: cover;
    }
  </style>
  <body style="margin: 0; overflow: hidden; background-color: #282c34">
    <canvas id="canvas" style="margin-top: 100px"></canvas>
    <script>
      // Pixi 앱 생성
      const app = new PIXI.Application({
        view: document.getElementById("canvas"),
        width: window.innerWidth,
        height: window.innerHeight,
        backgroundColor: 0x282c34,
        resizeTo: window,
      });

      let model;

      PIXI.live2d.Live2DModel.from(
        "./model/haru/runtime/haru_greeter_t05.model3.json"
      ).then((loadedModel) => {
        model = loadedModel;
        model.scale.set(0.5);
        model.x = app.renderer.width / 2.5;
        model.y = app.renderer.height * 1.5;
        model.anchor.set(0.5, 0.5);
        app.stage.addChild(model);
      });

      function speak(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "ko-KR";

        utterance.onstart = () => startLipSync();
        utterance.onend = () => stopLipSync();

        window.speechSynthesis.speak(utterance);
      }

      let lipSyncInterval;

      function startLipSync() {
        lipSyncInterval = setInterval(() => {
          const value = 0.5 + Math.random() * 0.5;
          if (model) {
            model.internalModel.coreModel.setParameterValueById(
              "ParamMouthOpenY",
              value
            );
          }
        }, 100);
      }

      function stopLipSync() {
        clearInterval(lipSyncInterval);
        if (model) {
          model.internalModel.coreModel.setParameterValueById(
            "ParamMouthOpenY",
            0
          );
        }
      }
    </script>
    <button onclick="speak('안녕하세요. 저는 하루에요!')">Haru가 말하기</button>
  </body>
</html>

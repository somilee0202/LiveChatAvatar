<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Live2D Viewer</title>

  <!-- PixiJS: 2D 그래픽 렌더링 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.10/browser/pixi.min.js"></script>

  <!-- Live2D Cubism Core 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/live2dcubismcore@1.0.2/live2dcubismcore.min.js"></script>

  <!-- pixi-live2d-display: Live2D 모델을 PixiJS에 연결해주는 라이브러리 -->
  <script src="https://unpkg.com/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>
</head>

<style>
  canvas {
    height: 500px;
    object-fit: cover;
  }
</style>

<body style="margin: 0; overflow: hidden; background-color: #282c34">
  <!-- Live2D 모델이 렌더링될 캔버스 -->
  <canvas id="canvas" style="margin-top: 100px"></canvas>

  <script>
    // 1️⃣ PixiJS 애플리케이션 생성
    const app = new PIXI.Application({
      view: document.getElementById("canvas"),
      width: window.innerWidth,
      height: window.innerHeight,
      backgroundColor: 0x282c34,
      resizeTo: window,
    });

    let model;  // 나중에 로드한 Live2D 모델을 저장할 변수

    // 2️⃣ Live2D 모델 로드
    PIXI.live2d.Live2DModel.from(
      "./model/haru/runtime/haru_greeter_t05.model3.json"  // 모델 경로
    ).then((loadedModel) => {
      model = loadedModel;
      model.scale.set(0.5);  // 모델 크기 조절
      model.x = app.renderer.width / 2.5;  // X 위치 조정
      model.y = app.renderer.height * 1.5; // Y 위치 조정
      model.anchor.set(0.5, 0.5);  // 중심 기준 설정
      app.stage.addChild(model);   // 화면에 추가

      startVolumeSync();  // 📢 볼륨 기반 립싱크 시작
    });

    // 3️⃣ (예시용) 브라우저 기본 TTS와 랜덤 립싱크 연동
    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "ko-KR";

      // 📌 입 가로 길이 조정: 'ㅣ', 'ㅐ', 'e', 'i' 등 포함 여부
      const widenMouthIfNeeded = (text) => {
        const wideSounds = ["i", "e", "ㅣ", "ㅔ", "ㅐ"];
        const narrowSounds = ["o", "u", "ㅗ", "ㅜ", "ㅡ"];
        const lower = text.toLowerCase();

        let widen = wideSounds.some(v => lower.includes(v));
        let narrow = narrowSounds.some(v => lower.includes(v));

        if (model) {
          const value = widen ? 1.0 : narrow ? 0.0 : 0.5;
          model.internalModel.coreModel.setParameterValueById("ParamMouthForm", value);
        }
      };

      utterance.onstart = () => {
        widenMouthIfNeeded(text);
      };

      utterance.onend = () => {
        if (model) {
          model.internalModel.coreModel.setParameterValueById("ParamMouthForm", 0.5);  // 중립으로
          model.internalModel.coreModel.setParameterValueById("ParamMouthOpenY", 0);   // 입 다물기
        }
      };

      window.speechSynthesis.speak(utterance);
    }


    // 5️⃣ 볼륨 기반 립싱크: backend/volume.json 파일을 50ms마다 읽어서 입모양 제어
    function startVolumeSync() {
      setInterval(async () => {
        try {
          // 📥 volume.json을 fetch (캐시 방지용 timestamp 추가)
          const res = await fetch("volume.json?_=" + Date.now());
          if (!res.ok) return;
          const { volume } = await res.json();  // { "volume": 0.123 }

          if (model && typeof volume === "number") {
            // 🔄 볼륨값을 ParamMouthOpenY에 반영 (0.01 이하면 입 닫기)
            const mouthValue = volume > 0.01 ? Math.min(volume * 4.0, 1.0) : 0;
            model.internalModel.coreModel.setParameterValueById(
              "ParamMouthOpenY",
              mouthValue
            );
          }
        } catch (e) {
          console.warn("볼륨 동기화 실패:", e);
        }
      }, 50);  // 🔁 50ms 주기 (20fps 수준)
    }
  </script>

  <!-- 버튼 클릭 시 speak 함수 호출 -->
  <button onclick="speak('안녕하세요. 저는 하루에요!')">Haru가 말하기</button>
</body>
</html>
